local util = asset.require('./utility_functions')

---------------------------------------------------------------- 
-- DEFAULT STATE - to reduce number of transitions
----------------------------------------------------------------
local defaultTargetDistance = 3.0E12

defaultState = {
    Identifier = "Default", 
    Enter = [[]],
    Exit = [[]]
}

---------------------------------------------------------------- 
-- 1. EARTH STATE
----------------------------------------------------------------
local earthTargetDistance = 26000000

earthState = {
    Identifier = "Earth", 
    Enter = [[
        openspace.printInfo('Entering Earth State')
        ]] .. util.setOrbitSpeedFactor(0.2) .. [[
        ]] .. util.orbitOnArrival() .. [[
    ]],
    Exit = [[
        openspace.printInfo('Exiting Earth State')
        ]] .. util.stopOrbiting() .. [[
    ]]
}

---------------------------------------------------------------- 
-- 2. GALAXY STATE
----------------------------------------------------------------
local fourGigaParsecsInMeter = 1.2342712E26
local galaxiesTargetDistance = fourGigaParsecsInMeter

galaxiesState = {
    Identifier = "Galaxies", 
    Enter = [[
        openspace.printInfo('Entering Galaxies State')
        ]] .. util.setOrbitSpeedFactor(0.05) .. [[
        ]] .. util.orbitOnArrival() .. [[

    ]],
    Exit = [[
        openspace.printInfo('Exiting Galaxies State')
        ]] .. util.stopOrbiting() .. [[
    ]]
}

---------------------------------------------------------------- 
-- 3. ASTEROIDS STATE
----------------------------------------------------------------
local interestingAsteroids = [[{
    'sssb_sssb_data_apollo_asteroid', 
    'sssb_sssb_data_aten_asteroid',
    'sssb_sssb_data_atira_asteroid', 
    'sssb_sssb_data_inner_main_belt_asteroid'
}]]

-- Set a specific property for the asteroid renderable
local setAsteroidsProperty = function(property, value, duration) 
    local interpolationDurationString = "";
    if(duration) then 
        interpolationDurationString = "," .. tostring(duration) .. ""
    end

    return [[
        local asteroids =]] .. interestingAsteroids .. [[
        for _, a in ipairs(asteroids) do
            openspace.setPropertyValueSingle(
                'Scene.' .. a .. '.Renderable.]] .. property .. [[', 
                ]] ..  tostring(value) .. [[
                ]] .. interpolationDurationString .. [[
            )
        end
    ]]
end

local asteroidsTargetDistance = 1e12
local fadeInDuration = 10
local fadeOutDuration = 10

asteroidsState = {
    Identifier = "Asteroids", 
    Enter = [[
        openspace.printInfo('Entering Asteroids State')
        ]] .. setAsteroidsProperty('Opacity', 0) .. [[
        ]] .. setAsteroidsProperty('Enabled', true) .. [[
        ]] .. setAsteroidsProperty('Opacity', 1, fadeInDuration) .. [[ 
        ]] .. util.setOrbitSpeedFactor(0.15) .. [[
        ]] .. util.orbitOnArrival() .. [[
    ]],
    Exit = [[
        openspace.printInfo('Exiting Asteroids State')
        ]] .. setAsteroidsProperty('Opacity', 0, fadeOutDuration) .. [[
        ]] .. setAsteroidsProperty('Enabled', false) .. [[ 
        ]] .. util.stopOrbiting() .. [[
    ]]
    -- OBS! Ideally we want to disable the asteroids after they are 
    -- completely faded out 
}

---------------------------------------------------------------- 
-- 4. MARS
----------------------------------------------------------------
local marsTargetDistance = 26000000

marsState = {
    Identifier = "Mars", 
    Enter = [[
        openspace.printInfo('Entering Mars State')
        ]] .. util.setOrbitSpeedFactor(0.2) .. [[
        ]] .. util.orbitOnArrival() .. [[
    ]],
    Exit = [[
        openspace.printInfo('Exiting Mars State')
        ]] .. util.stopOrbiting() .. [[
    ]]
}

---------------------------------------------------------------- 
-- 5. CONSTELLATIONS
----------------------------------------------------------------
local constellationsLinesMaxOpacity = 0.3
local constellationsFadeInOutDuration = 4

local constellationsTargetDistance = 2E9

local fadeLinesToOpacity = function(targetValue) 
    return [[
        openspace.setPropertyValueSingle(
            "Scene.Constellations.Renderable.Opacity", 
            ]] .. tostring(targetValue) .. [[,
            ]] .. tostring(constellationsFadeInOutDuration) .. [[
        )
    ]]
end

constellationsState = {
    Identifier = "Constellations", 
    Enter = [[
        openspace.printInfo('Entering Constellations State')
        ]] .. util.setOrbitSpeedFactor(0.2) .. [[
        ]] .. util.orbitOnArrival() .. [[
        ]] .. fadeLinesToOpacity(constellationsLinesMaxOpacity) .. [[
    ]],
    -- TODO: fade in constellation images when we have them laoded in the profile
    Exit = [[
        openspace.printInfo('Exiting Constellations State')
        ]] .. util.stopOrbiting() .. [[
        ]] .. fadeLinesToOpacity(0.0) .. [[
    ]]
}

---------------------------------------------------------------- 
-- COMBINE STATES AND TRANSITIONS
----------------------------------------------------------------
states = { 
    defaultState, 
    earthState, 
    galaxiesState, 
    asteroidsState, 
    marsState, 
    constellationsState
}

transitions = {
    -- 1. Earth
    {
        From = "Earth", 
        To = "Default", 
        Action = util.applyLinearFlight(defaultTargetDistance, 1.5)
    },
    {
        From = "Default", 
        To = "Earth", 
        Action = [[
            openspace.time.setPause(true)
            openspace.autonavigation.goTo('Earth', true)
        ]]
    },
    -- 2. Galaxies
    {
        From = "Galaxies", 
        To = "Default", 
        Action = util.applyLinearFlight(defaultTargetDistance, 1.5)
    },
    {
        From = "Default", 
        To = "Galaxies", 
        Action = util.applyLinearFlight(galaxiesTargetDistance, 1.5)
    },
    -- 3. Asteroids
    {
        From = "Asteroids", 
        To = "Default", 
        Action = [[
            ]] .. util.changeAnchor('Sun', 1) .. [[
            ]] .. util.applyLinearFlight(defaultTargetDistance, 1.5) .. [[
        ]]
    },
    {
        From = "Default", 
        To = "Asteroids", 
        Action = [[
            openspace.time.setPause(true)
            local targetDistance = ]] .. tostring(asteroidsTargetDistance) .. [[
            openspace.autonavigation.goToHeight('Sun', targetDistance, true, 10)
        ]]
    },
    -- 4. Mars
    {
        From = "Mars", 
        To = "Default", 
        Action = util.applyLinearFlight(defaultTargetDistance, 1.5)
    },
    {
        From = "Default", 
        To = "Mars", 
        Action = [[
            openspace.time.setPause(true)
            openspace.autonavigation.goTo('Mars', true)
        ]]
    },
    -- 5. Constellations
    {
        From = "Constellations", 
        To = "Default", 
        Action = util.applyLinearFlight(defaultTargetDistance, 1.5)
    },
    {
        From = "Default", 
        To = "Constellations", 
        Action = [[
            ]] .. util.changeAnchor('Earth', 2) .. [[
            ]] .. util.applyLinearFlight(constellationsTargetDistance, 1) .. [[
        ]]
    }
}

asset.onInitialize(function()
    openspace.statemachine.createStateMachine({
        States = states, 
        Transitions = transitions
    })
	openspace.statemachine.setInitialState("Earth");
end)
